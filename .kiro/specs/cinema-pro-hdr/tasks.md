# Cinema Pro HDR 实施计划

## 任务概述

本实施计划将Cinema Pro HDR系统的设计转化为一系列增量开发任务。每个任务都建立在前一个任务的基础上，确保代码的连续集成和功能的逐步完善。任务按照M1（2周DCTL原型+LUT导出）和M2（4-6周OFX插件Beta）的里程碑组织。

## 实施任务

- [x] 0. 试片与Golden资产准备
  - 固定12段样片与版权说明：夜景/逆光人像/霓虹/薄雾/高亮峰/肤色等基线样片
  - 生成64位RefMath曲线表与三预设参考帧：用Python/Float64离线高精度计算
  - 产物：assets/cliplist.json、golden/curves.csv、golden/frames/*.exr
  - 目的：CI的视觉回归与ΔE/闪烁对齐用统一参照
  - _需求: 7.4, 7.5, 8.1_

- [x] 1. 建立项目基础架构和核心接口
  - 创建CMake构建系统，支持跨平台编译（Windows/macOS/Linux）
  - 定义核心数据结构：CphParams、Image、Statistics、ErrorReport
  - 实现基础的色彩空间转换函数：PQ EOTF/OETF、BT.2020/P3-D65矩阵
  - 建立单元测试框架，包含数值精度和参数验证测试
  - _需求: 1.1, 3.1, 3.4_

- [ ] 1.1 实现PQ和色彩空间转换核心函数
  - 编写符合ST 2084标准的PQ EOTF/OETF函数
  - 实现BT.2020、P3-D65、ACEScg色彩空间转换矩阵
  - 添加工作域转换：输入域→BT.2020+PQ归一化→输出域
  - 创建色彩空间验证和边界检查函数
  - _需求: 3.1, 3.4, 11.1_

- [ ] 1.2 建立错误处理和日志系统
  - 实现三级回退机制：参数修正→标准回退→硬回退
  - 创建错误码枚举和ErrorReport结构，包含DCI_BOUND/GAMUT_OOG
  - 实现日志节流策略：同类错误每秒≤10条，超出聚合报告
  - 添加NaN/Inf检测和saturate()保护函数
  - _需求: 1.5, 1.7, 5.4, 失败保护条款_

- [ ] 1.2a 高精度基准实现（RefMath）
  - 用Python/Numpy写64位参考曲线（PPR/RLOG）、OKLab、ΔE00
  - 导出稠密采样表（≥16384点）用于CI对比
  - CI中对比GPU/OFX/DCTL输出与RefMath差异（误差栅格图&top-10 worst points）
  - 目的：一键定位数值分歧，避免"看起来像"的争执
  - _需求: 7.1, 7.4_

- [ ] 2. 实现PPR色调映射算法
  - 编写PPR核心算法：阴影段、高光段、拼接和软膝处理
  - 实现参数验证：γs∈[1.0,1.6]，γh∈[0.8,1.4]，h∈[0.5,3.0]，p∈[PQ(0.10),PQ(0.25)]
  - 添加单调性和C¹连续性验证：4096点采样+256问题点
  - 集成soft-knee和toe夹持：yknee∈[0.95,0.99]，alpha∈[0.2,1.0]，toe∈[0.0,0.01]
  - _需求: 1.1, 1.2, 1.4, 1.5, 7.1_

- [ ] 2.1 实现RLOG色调映射算法
  - 编写RLOG核心算法：暗部对数、高光有理式、smoothstep拼接
  - 实现参数验证：a∈[1,16]，b∈[0.8,1.2]，c∈[0.5,3.0]，t∈[0.4,0.7]
  - 添加拼接区间处理：[t-0.05, t+0.05]的平滑混合
  - 集成相同的软膝和toe夹持机制
  - _需求: 1.1, 1.3, 1.4, 1.5_

- [ ] 2.2 实现高光细节处理模块
  - 编写USM算法：仅作用于x>p区域，r=2px，amount=0.2，thr=0.03
  - 实现运动保护：帧间差分检测，能量门限抑制闪烁
  - 添加频域约束检查：1-6Hz区间能量增长<20%
  - 集成到主处理管线中，支持λ_hd∈[0,1]强度控制
  - _需求: 2.3, 3.4, 7.2, 7.3_

- [ ] 2.3 实现OKLab饱和度处理
  - 编写RGB↔OKLab转换函数
  - 实现基础饱和度调节：sat_base∈[0,2]全局缩放
  - 添加高光区域饱和度：sat_hi∈[0,2]，权重w_hi=smoothstep(p,1,x)
  - 集成色域越界检查和两级处理机制
  - _需求: 3.3, 11.1, 11.2_

- [ ] 3. 创建DCTL原型实现
  - 将PPR和RLOG算法移植到DCTL格式
  - 实现参数传递机制：通过Resolve UI传递全局常量
  - 优化GPU性能：避免分支，使用权重混合，FP16+FP32混合精度
  - 添加实时统计收集：min/avg/max PqEncodedMaxRGB计算
  - _需求: 1.1, 1.2, 6.1, 6.2, 6.3_

- [ ] 3.0a 模块性能预算与报告
  - 目标（4K24单节点）：曲线≤0.35ms；细节层≤0.35ms；OKLab≤0.20ms；统计≤0.10ms
  - CI输出分项时间；超过预算标红并阻断合并
  - 记录单节点预算分解，为后期优化提供指向
  - _需求: 6.1, 6.2, 6.4_

- [ ] 3.1 DCTL性能优化和验证
  - 实现确定性模式：关闭所有随机抖动/蓝噪/近似指令；采用IEEE严格数学（-ffp-contract=off）与固定FMA行为
  - 添加性能测量：4K24p<1.0ms，8K24p<3.5ms目标验证
  - 进行跨GPU一致性测试：NVIDIA/AMD/Apple差异≤1 LSB
  - 创建三套预设：Cinema-Flat、Cinema-Punch、Cinema-Highlight（预设v1.0冻结入仓，变更需走评审并生成ΔE与闪烁差异报告）
  - _需求: 3.2, 6.4, 6.5, 7.4, 预设快照_

- [ ] 4. 实现LUT烘焙引擎
  - 创建CubeLUT数据结构和.cube文件I/O
  - 实现33³和65³分辨率的LUT烘焙算法
  - 添加误差报告：在P3-D65中1,000,000随机点+边界格点采样
  - 集成ΔE00计算：目标均值≤0.5，99分位≤1.0，最大≤2.0
  - _需求: 4.1, 4.2, 4.3, 4.5_

- [ ] 4.1 LUT导出工具和验证
  - 创建cph_lut_baker命令行工具：支持--grid 33|65 --in-cs --out-cs --report json
  - 实现LUT头部元信息写入：源/目标色域、白点、曲线参数快照
  - 添加top-10 worst cases输出：失败样本的代表性颜色坐标
  - 集成确定性模式：不同GPU输出字节级一致，工具链能抛出DCI_BOUND/GAMUT_OOG错误码
  - _需求: 4.1, 4.2, 8.1, 11.4_

- [ ] 5. 实现侧车文件系统
  - 创建JSON schema验证器：基于完整的schema定义
  - 实现SidecarManager类：导出CPH扩展块和ST 2094-10基础层
  - 添加统计信息收集：1%顶帽去极值，截尾均值计算
  - 集成时间码和clip GUID处理：HH:MM:SS:FF格式，UUID验证
  - _需求: 5.1, 5.2, 5.3, 5.4, JSON Schema_

- [ ] 5.1 创建JSON验证工具
  - 实现cph_json_check命令行工具：返回具体字段级错误码
  - 添加schema版本兼容性检查：cph_version>2时强制回退
  - 实现参数范围验证：所有数值字段的minimum/maximum检查
  - 集成回退策略：扩展块异常时使用ST 2094-10基础层
  - _需求: 5.1, 5.4, 8.2, JSON Schema_

- [ ] 6. 开发OFX插件框架
  - 创建OFX插件基础架构：参数定义、UI布局、渲染管线
  - 实现UI→算法参数映射：所有控件到内部参数的转换公式
  - 添加实时统计显示：min/avg/max PqEncodedMaxRGB面板
  - 集成预设系统：三套预设的加载、保存、导入/导出功能
  - _需求: 2.1, 2.2, 2.4, 2.5, UI映射_

- [ ] 6.1 实现OFX参数控件和映射
  - 创建所有UI控件：Pivot（Nits+PQ双显示）、Shadows/Highlight Contrast、Roll-off等
  - 实现PPR参数映射：γs=1.0+0.6*S，γh=0.8+0.6*H，h=0.5+2.5*R
  - 添加RLOG参数映射：a=1+15*S，b=0.8+0.4*G，c=0.5+2.5*R，t=0.4+0.3*B
  - 集成DCI合规模式开关和确定性模式选项
  - _需求: 2.1, 10.1, UI映射完整版_

- [ ] 6.2 实现OFX实时处理和统计
  - 集成核心处理引擎到OFX渲染管线
  - 实现实时统计计算：当前可见帧或用户选择区段的统计
  - 添加单调性和C¹连续性状态指示灯
  - 集成侧车导出按钮：为当前Clip/Timeline生成.cph.json
  - _需求: 2.3, 2.4, 2.5, 5.3_

- [ ] 7. 实现DCI合规和色域处理
  - 添加DCI_Compliance_Mode：P3-D65色容积限制，影院黑位0.005 cd/m²约束
  - 实现两级色域处理：3×3矩阵线性压制+OKLab感知夹持
  - 集成交付报告生成：白点/黑位测得值、EOTF标识、色域边界检查
  - 添加越界检测：输出越界像素占比、最大越界幅度、示例色点
  - _需求: 10.1, 10.2, 10.3, 11.1, 11.2_

- [ ] 7.1 完善DCI模式和报告系统
  - 实现DCP/DCDM导出报告：峰值跟踪容差、色域边界抽样检查结果
  - 添加越界时的非0退出码：失败样本帧与坐标标注（≥10个）
  - 集成保守饱和度策略：DCI模式下sat_hi施加5-10%衰减
  - 完善错误码系统：DCI_BOUND、GAMUT_OOG错误类型
  - _需求: 10.3, 10.4, 11.3, 错误码表_

- [ ] 7.1a DCP信令与元数据检查
  - 验证CPL/PKL中EOTF=ST2084的标记、Track的Transfer Characteristic设置
  - 导出合规报告（pass/fail），避免最后一公里的规范口水战
  - 集成到DCI_Compliance_Mode的完整验证流程中
  - _需求: 10.2, 10.3_

- [ ] 8. 创建测试套件和验证系统
  - 实现数值精度测试：单调性、C¹连续性、量化误差验证
  - 创建性能基准测试：4×12s测试序列，中位数和P95统计
  - 添加闪烁检测测试：帧差RMS能量和频域分析
  - 集成跨平台一致性验证：确定性模式下的GPU对比测试
  - _需求: 7.1, 7.2, 7.3, 7.4, 6.2_

- [ ] 8.1 实现视觉质量和误差分析
  - 创建ΔE00计算和报告系统：P3-D65色彩空间下的精度分析
  - 实现样片质量评估：至少12个不同类型测试样片的处理
  - 添加LUT精度验证：1M随机点采样，均值/分位数/最大值报告
  - 集成A/B对比工具：CPH扩展层开关前后的视觉对比
  - _需求: 4.3, 7.5, 视觉质量测试_

- [ ] 8.1a 双盲评测协议
  - 评审人数≥10，随机化顺序，统一影院环境/亮度；每条目二选一偏好记录
  - 输出p-value与偏好比例；达标：≥60%且p<0.05
  - 让"≥60%偏好"有统计学脚注，确保评测结果可信
  - _需求: M2验收标准_

- [ ] 9. 完善工具链和批处理支持
  - 扩展cph_lut_baker功能：批量LUT生成，参数文件支持
  - 实现批处理脚本：按时间码段拆分生成多段JSON
  - 添加参数快照功能：--snapshot将参数写入.cube注释
  - 集成CI自动化：四图表自动产出（ΔE/单调/C¹/性能）
  - _需求: 8.1, 8.3, 8.4, 8.5_

- [ ] 9.1 创建文档和示例项目
  - 编写用户手册：包含RCM/ACES放置建议和节点顺序截图
  - 创建故障排除指南：黑位发灰、亮峰炸点、肤色偏移的处理清单
  - 准备示例项目：三套预设、样片、输出LUT、侧车JSON
  - 完善API文档：开发者集成指南和最佳实践
  - _需求: 9.1, 9.2, 9.3, 9.4_

- [ ] 9.3* 专利证据链采集
  - 每次曲线/接口变更自动生成差异报告（公式/参数域/示例图），归档到ip_evidence/
  - 目的：提交专利与对比现有技术时一站式取证
  - _需求: 知识产权保护_

- [ ] 10. 系统集成和最终验收
  - 进行端到端测试：完整工作流程的验证
  - 执行性能回归测试：确保所有性能目标达成
  - 完成跨平台兼容性验证：Windows/macOS全平台测试（OFX/DCTL主Host以Win/macOS为主；Linux走核心库与工具链验证）
  - 准备最终交付物：签名的OFX bundle、DCTL文件、工具链、文档
  - _需求: 所有需求的综合验证_

## 可选任务（标记为*的子任务）

以下任务为可选实现，专注于核心功能优先：

- [ ]* 1.3 实现高级色彩管理功能
  - 添加OCIO配置文件支持
  - 实现自定义色彩空间定义
  - 集成色彩管理工作流程验证
  - _需求: 3.3_

- [ ]* 2.4 添加高级USM选项
  - 实现多尺度USM算法
  - 添加边缘保护和细节增强选项
  - 集成自适应阈值调节
  - _需求: 2.3_

- [ ]* 4.2 扩展LUT格式支持
  - 添加.3dl、.csp格式支持
  - 实现HDR10+元数据集成
  - 支持动态元数据LUT导出
  - _需求: 4.4_

- [ ]* 6.3 实现高级OFX功能
  - 添加实时波形显示
  - 集成色彩空间可视化
  - 实现参数动画支持
  - _需求: 2.5_

- [ ]* 8.2 扩展测试覆盖
  - 添加压力测试和长时间稳定性测试
  - 实现自动化视觉回归测试
  - 集成性能分析和优化建议
  - _需求: 6.5, 7.5_

- [ ]* 9.2 创建高级工具
  - 实现图形化参数调节工具
  - 添加批量处理GUI界面
  - 集成项目管理和版本控制
  - _需求: 8.3, 8.4_

## 里程碑验收标准

### M1验收（第2-3周）
- DCTL可实时渲染PPR和RLOG曲线
- 三套预设可用且参数正确
- LUT导出功能完整（33³/65³ + 误差报告）
- 侧车JSON写出功能正常
- 数值测试全部通过（单调性、C¹连续性、精度）
- **RefMath对齐**：GPU/DCTL输出与64位参考曲线的最大偏差<1 LSB（10/12bit对应量化后）
- **Golden样片重现**：三套预设对基线样片的ΔE00报告与golden一致性通过（均值/99分位达标）

### M2验收（第4-6周）  
- OFX插件UI完整且功能正常
- 批量应用和Timeline预设支持
- 统计面板显示准确
- 回退策略验证通过
- A/B双盲测试：≥60%受试者偏好CPH相对基础层（≥60%且p<0.05）
- **DCI报告可审**：DCI_Compliance_Mode报告包含白点/黑位实测、EOTF标识、色域边界检查与越界样本；失败返回非0