# 报告总览（一句话版）

* **你要做的系统**：把电影的 HDR 画面，按创作者的意图，稳定地映射到不同的显示/放映条件上（例如影院放映），同时兼容行业标准（ST 2094-10、DCI）。
* **怎么实现**：先做**快速原型**（DCTL）+**离线输出**（LUT），再做**正式插件**（OFX），中间有一套**核心库**和**工具链**打底。
* **验收方法**：既看主观观感（A/B 双盲），也看客观指标（单调、连续、ΔE、性能、闪烁、合规性）。

---

# 里程碑（你可以拿去对齐进度）

* **M1（第2–3周）**：
  出一个可实时跑的**DCTL 原型**、能导出**LUT**、能写**侧车 JSON**。
* **M2（第4–6周）**：
  交付一个可用的**OFX 插件 Beta**（完整 UI、预设、统计、批量应用），并通过一轮影厅/放映 PoC。

---

# 关键概念，用人话说

* **DCTL**：达芬奇的“计算器小脚本”，上手快，适合做原型（像搭积木先搭个样子）。
* **OFX 插件**：真正的“产品级插件”，带 UI、能批量处理（像把乐高搭成能用的机器）。
* **LUT**：把复杂变换烘焙成一张“查表”，别的设备不用装插件也能套用（像把菜谱写成清单）。
* **侧车 JSON**：装参数的“便签纸”，播放器/放映服务器看得懂就用，看不懂就按老标准回退（不坏事）。
* **PPR/RLOG 曲线**：两种原创的亮度映射方法，控制画面“暗部对比”“高光过渡”等关键感觉。

---

# 分任务白话解读（做什么 / 产出 / 有什么用 / 完成判定）

> 任务编号与你的实施计划一一对应。每条都含四件事：**做什么、产出、作用、完成判定**。

## 0. 试片与“黄金基线”

* **做什么**：固定 12 段代表性视频；用高精度脚本生成“金标准”曲线/参考帧。
* **产出**：`assets/cliplist.json`、`golden/curves.csv`、`golden/frames/*.exr`
* **作用**：后续任何改动，都能拿来对比“有没有变坏”；避免扯皮。
* **完成判定**：有固定清单和文件，CI 能自动读出来对比。

---

## 1. 搭框架 & 基础设施（1 / 1.1 / 1.2）

* **做什么**：建工程（CMake、目录、测试），把 PQ、色彩空间（BT.2020/P3-D65/ACEScg）这些“底层砖”先铺好；统一错误码和日志。
* **产出**：基础库 + 单元测试 + 日志系统 + `cs_config.json`
* **作用**：后面所有算法和插件都复用这套底座，避免重复造轮子。
* **完成判定**：跑测试通过；错误能被优雅捕获并记录（有节流）。

---

## 2. 亮度映射算法：PPR（2）与 RLOG（2.1）

* **做什么**：把两条“自研曲线”做成可调用函数；保证“单调不倒退”“接缝平滑”；加上“软膝/黑位夹持”防炸峰、防发灰。
* **产出**：`CphPpr()`、`CphRlog()` 函数 + 单调/C¹测试报告
* **作用**：画面暗部和高光的“手感”就靠它们；它们是“味道”的核心。
* **完成判定**：4096 点采样单调；枢轴附近 C¹ 连续；边界参数复位有日志。

---

## 2.2 高光细节模块（只在高光区做“有节制”的锐化）

* **做什么**：只在 x>p 的高光区域做一点点 USM 提细节，配阈值和“运动保护”（避免闪烁）。
* **产出**：`ApplyHighlightDetail()` + 频域报告（1–6 Hz 不超 20%）
* **作用**：让高光有质地、不塑料；同时不让画面“喘气”。
* **完成判定**：打开/关闭细节层，闪烁指标不过线；默认参数安全。

---

## 2.3 OKLab 饱和度处理（分全局 & 高光）

* **做什么**：把颜色转到 OKLab 空间里再调饱和度，回去时做两级“回扣”（不出界）。
* **产出**：`ApplySaturationOKLab()` + 越界比例/示例点报告
* **作用**：颜色“饱”和“雅”全靠它，避免影院里“溢色”。
* **完成判定**：越界像素占比合理（报告可见）；视觉上不失真。

---

## 3. DCTL 原型（3 / 3.1）

* **做什么**：把上面的算法搬到 DCTL，能在达芬奇里实时跑；做预设、统计面板、确定性模式。
* **产出**：`CPH_PPR.dctl`、`CPH_RLOG.dctl`、三套预设、性能日志
* **作用**：最快速的“可视化试吃”，调色师能当场“扭旋钮看变化”。
* **完成判定**：4K24 < 1.0ms；8K24 < 3.5ms；三预设效果正确；跨 GPU 一致（确定性模式）。

---

## 4. LUT 烘焙（4 / 4.1）

* **做什么**：把当前参数烤成 .cube（33³/65³），并评估颜色精度（ΔE00）。
* **产出**：`.cube` 文件 + JSON 报告（均值/95/99 分位/最大 + worst10）
* **作用**：给不装插件的系统用（放映服务器、其他软件）。
* **完成判定**：ΔE00 均值 ≤ 0.5、P99 ≤ 1.0、最大 ≤ 2.0；误差超限自动失败。

---

## 5. 侧车 JSON（5 / 5.1）

* **做什么**：定义并校验 JSON 格式，写基础层（ST 2094-10 统计）+ 扩展层（你的参数）。
* **产出**：`.cph.json` + `cph_json_check` 工具 + 错误码（如 SCHEMA_MISSING）
* **作用**：实现“看得懂就用扩展，看不懂就回退”的**安全兼容**。
* **完成判定**：错误能被工具抓到并回退；时间码/GUID 校验严谨。

---

## 6. OFX 插件（6 / 6.1 / 6.2）

* **做什么**：把 DCTL 原型升级成“产品插件”：UI 控件、参数映射、批量应用、侧车导出、统计面板。
* **产出**：`CinemaProHDR.ofx.bundle` + 预设导入导出
* **作用**：面向日常项目使用，交付给调色师/后期团队的正式工具。
* **完成判定**：UI 全功能并实时；预设/统计/侧车一键可用。

---

## 7. DCI 合规 & 色域越界（7 / 7.1）

* **做什么**：加一个“DCI 合规模式”开关，限制在 P3-D65 色容积，生成放映检查报告。
* **产出**：合规报告（白点/黑位、EOTF=ST2084、色域边界抽样、越界样本）；错误码（DCI_BOUND/GAMUT_OOG）
* **作用**：确保影院放映“不过界、不过曝”，顺利过审。
* **完成判定**：合规报告通过，失败时返回非 0 并指明样本帧。

---

## 8. 测试与验证（8 / 8.1）

* **做什么**：把“好不好”量化：单调/C¹、性能、闪烁、跨平台、ΔE00、A/B 双盲。
* **产出**：自动化测试套件 + 报告图表（四张：ΔE/单调/C¹/性能）+ A/B 统计
* **作用**：从“看着像”升级为“数据上也对”，便于团队协作和外部评审。
* **完成判定**：所有阈值过线；双盲偏好 ≥ 60% 且 p<0.05。

---

## 9. 工具链与文档（9 / 9.1）

* **做什么**：命令行工具、批处理脚本、用户手册、API 文档、示例工程、故障排除清单。
* **产出**：`cph_lut_baker`、`cph_json_check`、手册、样例项目（预设/样片/侧车/LUT）
* **作用**：让别人能用、用得稳、遇事能查。
* **完成判定**：新人照着文档能跑通全流程；CI 能批量跑工具链。

---

## 10. 最终集成与验收

* **做什么**：把全部环节串起来“从导入素材到导出成品”走一遍；做平台和性能回归。
* **产出**：签名的 OFX 插件、DCTL 文件、工具包、完整文档与报告。
* **作用**：对外交付版本，能装、能用、能审。
* **完成判定**：端到端测试绿灯；验收清单逐条通过。

---

# 整体流程，用逛超市来比喻

1. **先备购物车**（0,1）：把车（工程脚手架）和购物清单（试片/黄金基线）准备好。
2. **挑主食**（2）：决定米饭/面食的做法（PPR/RLOG 曲线定型）。
3. **加佐料**（2.2, 2.3）：适量盐（饱和度）和胡椒（高光细节），但不过量。
4. **现场试吃**（3）：DCTL 现做现吃，边吃边改。
5. **打包外带**（4,5）：做成 LUT（便携）、配上侧车参数（说明书）。
6. **上架成品**（6）：做成 UI 友好的正式插件，支持批量。
7. **通过质检**（7,8）：看检验报告（合规、ΔE、性能、闪烁、A/B）。
8. **出门结账**（9,10）：打包交付，票据齐全（文档/工具/签名）。

---

# 最常见的三个疑问

**Q1：为什么要两种曲线（PPR 和 RLOG）？**
A：口味不同。PPR 更像“精致的电影风味”，控制暗部/高光都顺手；RLOG 像“硬朗的纪录片风”，适合压住极端场景。两个都简单、可算、可专利。

**Q2：为什么既要 DCTL 又要 OFX？**
A：DCTL 快（两周能见效），便于调教味道；OFX 正式（UI、批量、互操作），适合团队日常使用。

**Q3：侧车 JSON 有啥用？**
A：是你的“二次点火器”。播放器/放映机能读就用你的高级效果，读不了就按旧标准渲染，不会黑屏——兼容永远比花哨重要。

---

# 一页路线图（你可以发给团队）

* **第 1 周**：
  0/1 完成；PPR 初版跑起来；有第一帧 DCTL 输出。
* **第 2–3 周（M1）**：
  RLOG、细节/饱和、LUT 烘焙、侧车写出；ΔE/单调/C¹/性能报告齐活。
* **第 4–6 周（M2）**：
  OFX UI、预设、统计、批量；DCI 合规与色域处理；A/B 双盲与放映 PoC；交付文档。

---

# 你怎么判断“我做对了”

* 打开任意样片，切换三套预设，**暗部不发灰**、**高光不过曝**、**肤色不怪**。
* 开/关“高光细节”没有明显“呼吸感”；统计面板数值合理。
* LUT 导出误差报告是绿的；侧车 JSON 一键校验通过。
* DCI 合规报告通过；A/B 双盲里，多数人更喜欢你这版。

